---
title: "Comparing models"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(eval.after = "fig.cap")
```

# Introduction

We have developed a two-sex four-stage (age) structured population reconstruction model for lynx in Norway. The model uses data from the observation of Family Groups and Harvest records (known age and sex of harvested lynx) in a state-space modelling framework. The model is based on code by Allen et al. 2018. 

Here we compare the original female-only prognostic model with this new age-at-harvest population reconstruction model. The two models, although fundamentally based on the state-space structure and observation data, model different component parts of the population. The Age-at-harvest population reconstruction uses the known harvest as an extra observation data set in the model. This allows, for example, a population estimate to be calculated as the sum of the simulated stage-structured population rather than using a population scaling index from the Family Group estimate. The Age-at-harvest population reconstruction gives a more ecologically realistic model but this does come at a cost of greater uncertainty in estimates. 

# Method

To compare the models we only look at the predictive accuracy in relation to the Family Group estimate compared to the Family Group observation. We first ran each model from 1996 to 2006 without the final years Family Group observation and compared the predicted Family Group estimate to the observed value. We then repeated this process for 2007 through to 2018. As such each year between 2006 and 2018 has a predicted Family Group estimate compared to the true Family Group observation for each model.

# Results

We express the difference between the Family Group estimate and Family Group observation in three ways.

First we plot the observed versus the predicted Family Group with associated error (95% Credible Interval) for each model (Figure 1). Both models have similar performance when predicting the observed Family Group size, although there is a greater amount of error associated with the Age-at-Harvest population reconstruction model. 


```{r model outputs, message=FALSE, warning=FALSE, echo=FALSE, fig.cap="Figure 1. Observed (grey points) versus predicted (coloured point with 95% error bars) Family Group in the Female only prognostic model (blue) and the Age-at-harvest model (red)"  }
library(patchwork)
library(tidyverse)
tab<-data.frame(Year=seq(2006, 2018, 1),
                "Female"= c(45.15,55.43,68.4,79.09,80.62,91.79,72.67,66.15,53.4,61.88,53.73,58.26,62.34),
                "Lower_Female"=c(33.88,42.68,53.95,64.55,66.8,76.41,61.22,56.28,44.686,52.79,45.76,49.62,53.802), 
                "Upper_Female"=c(56.42,68.18,82.85,93.63,94.44,107.17,84.12,76.02,62.114,70.97,61.7,66.9,70.878),
                "Observed"= c(65,74,76,92,80,74,69,52.5,53,60.5,52,55.5,57.5),
                "Full"=c(50.74,60.43,72.37,69.85,89.35,78.97,64.17,66.28,69.63,54.43,59.93,56.87,53.37), 
                "Lower_Full"=c(32.85,41.41,51.64,47.43,65.27,53.24,38.24,41.05,43.71,33.09,35.09,35.8,33.8),
"Upper_Full"=c(69.94,80.78,94.6,93.53,114.45,104.37,90.15,91.42,94.64,76.85,82.72,77.03,76.92))

# tab %>% 
#   gather(key=key, value=value, -year) %>%
#   filter(key==c("Female","Full", "Observed")) %>% 
#   ggplot(aes(year, value, colour=key)) +
#   geom_point()

p1<-tab %>% 
  ggplot(aes(Year, Observed))+
  geom_point(colour= "dark green", size=2)+
  geom_pointrange(aes(x=Year, y= Female, ymin=Lower_Female, ymax=Upper_Female), colour="blue")+
  ggthemes::theme_base()+
  ggtitle("Female only prognostic model")+
  theme(plot.title = element_text(size = 12, face = "bold", hjust = 0.5))

  #geom_pointrange(aes(x=year, y= Full, ymin=Lower_Full, ymax=Upper_Full), colour="red")

p2<-tab %>% 
  ggplot(aes(Year, Observed))+
  geom_point(colour= "dark green", size=2)+
  geom_pointrange(aes(x=Year, y= Full, ymin=Lower_Full, ymax=Upper_Full), colour="red")+
  ggthemes::theme_base()+
  ggtitle("Age-at-harvest model")+
  theme(plot.title = element_text(size = 12, face = "bold", hjust = 0.5))



p1+p2

```


Next we look at the absolute error (how much numeric difference there is between the observed and predicted Family Group number) (Figure 2). As both models increase in the number of years of observations the absolute error (in particular underestimation) decreases. Once again the Age-at-Harvest population reconstruction model has a greater level of uncertainty than the Female only prognostic model. 


```{r, echo=FALSE}
# tab %>% 
#   ggplot(aes(Female, Observed)) + 
#   geom_point()+
#     geom_smooth(method='lm')
# 
# summary(lm(Female~Observed, tab))
# 
# 
# tab %>% 
#   ggplot(aes(Full, Observed)) + 
#   geom_point()+
#   geom_smooth(method='lm')
# 
# summary(lm(Full~Observed, tab))
# 
  
```


```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="Figure 2. Absolute error in Family Group estimates in the Female only prognostic model (blue) and the Age-at-harvest model (red)" }
p3<-tab %>% 
  mutate(Abs_error_Female= Female-Observed) %>% 
  mutate(Abs_error_Full= Full-Observed) %>% 
  ggplot(aes(Year, Abs_error_Female)) +
  geom_point(colour="blue")+
  geom_smooth()+
  ggthemes::theme_base()+
    labs(y= "Absolute error")+
  ggtitle("Female only prognostic model")+
  theme(plot.title = element_text(size = 12, face = "bold", hjust = 0.5))

p4<-tab %>% 
  mutate(Abs_error_Female= Female-Observed) %>% 
  mutate(Abs_error_Full= Full-Observed) %>% 
  ggplot(aes(Year, Abs_error_Full)) +
  geom_point(colour="red")+
  geom_smooth(colour="red")+
  ggthemes::theme_base()+
  labs(y= "Absolute error")+
  ggtitle("Age-at-harvest model")+
  theme(plot.title = element_text(size = 12, face = "bold", hjust = 0.5))

p3+p4



```

Finally, we address the classification accuracy of the models in terms of correctly predicting if the number of Family Groups is correctly determined to be above or below the population target of 65 Family Groups (Figure 3). Again, related to the larger uncertainty associated with the Age-at-Harvest population reconstruction model (i.e. lower specificity) meant that the model is less good at classification with a AUC of 0.69 compared to AUC 0.85 for the Female only prognostic model. 

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="Figure 3. Receiver operator curve for the Female only prognostic model (blue) and the Age-at-harvest model (red) comparing the classification accuracy of predicting if the following years Family Group estimate will be above or below the country target of 65 Family Groups" }
library(pROC)
library(caret)

test<-tab %>% 
  mutate(X=ifelse(Observed>65, 1,0)) %>% 
  mutate(Y=ifelse(Female>65, 1,0))

FG_sens<-sensitivity(factor(test$Y),factor(test$X))
FG_spec<-specificity(factor(test$Y),factor(test$X))
FG_roc<-roc(test$Y,test$X,ci=TRUE,plot=FALSE, auc.polygon=TRUE, max.auc.polygon=TRUE, grid=TRUE, print.auc=TRUE, show.thres=TRUE)


test2<-tab %>% 
  mutate(X=ifelse(Observed>65, 1,0)) %>% 
  mutate(Y=ifelse(Full>65, 1,0))
FG_sens2<-sensitivity(factor(test2$Y),factor(test2$X))
FG_spec2<-specificity(factor(test2$Y),factor(test2$X))
FG_roc2<-roc(test2$Y,test2$X,ci=TRUE,plot=FALSE, auc.polygon=TRUE, max.auc.polygon=TRUE, grid=TRUE, print.auc=TRUE, show.thres=TRUE)

p5<-ggroc(FG_roc, colour="blue")+
  geom_segment(aes(x = 1, xend = 0, y = 0, yend = 1), color="grey", linetype="dashed")+
    ggthemes::theme_base()+
  ggtitle("Female only prognostic model")+
  theme(plot.title = element_text(size = 12, face = "bold", hjust = 0.5))+
  annotate("text", x=0.35, y=0.20, label="AUC: 0.85 95% CI: 0.63-1")

p6<-ggroc(FG_roc2, colour="red")+
  geom_segment(aes(x = 1, xend = 0, y = 0, yend = 1), color="grey", linetype="dashed")+
    ggthemes::theme_base()+
  ggtitle("Age-at-harvest model")+
  theme(plot.title = element_text(size = 12, face = "bold", hjust = 0.5))+
  annotate("text", x=0.35, y=0.20, label="AUC: 0.69 95% CI: 0.41-0.97")

p5+p6

```

# Conclusion

The greater uncertainty associated with the Age-at-Harvest population reconstruction model means that it is slightly less good at estimating the Family Group observation per year. However, the model does predict the true Family Group well and has the added ecological complexity which can be utilised for answering questions about other components of the population and not just the breeding females. 


